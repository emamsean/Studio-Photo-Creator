<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HEN1VWJL4B"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-HEN1VWJL4B');
</script>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WG93PS73');</script>
<meta charset="UTF-8" />
<title>Photo Studio Prompt Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    /* BASE STYLES & COLORS (Modern Dark Theme) */
    html, body { margin: 0; padding: 0; background: transparent; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #e5e7eb; }
    .app { background: radial-gradient(circle at top left, #020617 0%, #020617 40%, #020617 100%); padding: 18px 16px 22px; box-sizing: border-box; width: 100%; max-width: 100%; margin: 0; border-radius: 16px; border: 1px solid rgba(148, 163, 184, 0.25); }
    h1 { font-size: 1.25rem; margin-bottom: 4px; letter-spacing: 0.01em; }
    .step-guide { font-size: 0.9rem; color: #cbd5f5; margin-bottom: 10px; line-height: 1.5; }
    .step-guide b { color: #22c55e; font-weight: 700; }
    .field-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 0.85rem; color: #e5e7eb; }
    select, input[type="text"], textarea, input[type="file"] { background: #020617; border-radius: 8px; border: 1px solid #4b5563; padding: 8px 10px; color: #e5e7eb; font-family: inherit; font-size: 0.9rem; outline: none; box-sizing: border-box; transition: border-color 0.18s ease, box-shadow 0.18s ease, background 0.18s ease; }
    select:focus, input[type="text"]:focus, textarea:focus, input[type="file"]:focus { border-color: #0ea5e9; box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.4); background: #020a1a; }
    .custom-input { font-size: 0.8rem; color: #9ca3af; }
    textarea { width: 100%; min-height: 150px; resize: vertical; margin-top: 8px; white-space: pre-wrap; }
    /* BUTTONS */
    .buttons { display: flex; gap: 8px; margin: 14px 0; flex-wrap: wrap; }
    button { border-radius: 999px; border: none; padding: 8px 16px; font-size: 0.9rem; cursor: pointer; font-family: inherit; transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.15s ease; }
    .btn-primary { background: linear-gradient(135deg, #0ea5e9, #22c55e); color: white; font-weight: 600; box-shadow: 0 8px 18px rgba(34, 197, 94, 0.3); }
    .btn-secondary { background: rgba(15, 23, 42, 0.8); color: #e5e7eb; border: 1px solid #4b5563; }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35); }
    button:active { transform: translateY(0); box-shadow: none; }
    .section-title { font-size: 0.9rem; margin: 10px 0 6px; color: #e5e7eb; font-weight: 600; }
    .hint { font-size: 0.78rem; color: #9ca3af; }
    .preset-preview-box { margin-top: 10px; margin-bottom: 12px; }
    .preset-preview-box img { width: 100%; border-radius: 12px; border: 1px solid #4b5563; display: none; object-fit: cover; }
    .preset-preview-caption { font-size: 0.78rem; color: #9ca3af; margin-top: 4px; }
    @media (max-width: 650px) { .field-group { grid-template-columns: 1fr; } }
    /* --- MODERN TAB STYLES --- */
    .tabs { display: flex; gap: 6px; margin: 12px 0 10px; padding: 3px; border-radius: 999px; background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9)); border: 1px solid rgba(30, 64, 175, 0.6); overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tabs::-webkit-scrollbar { height: 0; }
    .tab-button { background: transparent; color: #9ca3af; border: none; border-radius: 999px; padding: 6px 12px; font-weight: 500; cursor: pointer; transition: color 0.18s ease, background 0.18s ease, transform 0.12s ease, box-shadow 0.12s ease; white-space: nowrap; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 4px; }
    .tab-button::before { content: "â€¢"; font-size: 0.8rem; opacity: 0.6; }
    .tab-button:hover { color: #e5e7eb; background: rgba(30, 64, 175, 0.3); }
    .tab-button.active { color: #f9fafb; background: linear-gradient(135deg, #0ea5e9, #22c55e); box-shadow: 0 6px 16px rgba(15, 118, 110, 0.45); transform: translateY(-1px); }
    .tab-button.active::before { opacity: 0; }
    .tab-content { display: none; padding-top: 8px; }
    .tab-content.active { display: block; }
    /* QUICK LOOKS GRID */
    .quick-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .preset-card { background: rgba(15, 23, 42, 0.9); border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.3); padding: 4px; cursor: pointer; display: flex; flex-direction: column; gap: 4px; transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease; }
    .preset-card img { width: 100%; height: 70px; object-fit: cover; border-radius: 7px; }
    .preset-card-title { font-size: 0.7rem; color: #e5e7eb; text-align: center; line-height: 1.2; }
    .preset-card:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); border-color: rgba(56, 189, 248, 0.8); }
    .preset-card.selected { border-color: #22c55e; box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.7); background: radial-gradient(circle at top, rgba(22, 101, 52, 0.35), rgba(15, 23, 42, 0.95)); }
    .prompt-panel { margin-top: 16px; padding-top: 10px; border-top: 1px solid rgba(55, 65, 81, 0.8); }
    .prompt-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 4px; }
    /* Upload + output styling */
    .image-upload-section { margin-top: 14px; margin-bottom: 10px; }
    .image-preview { margin-top: 6px; max-width: 100%; border-radius: 12px; border: 1px solid #4b5563; display: none; object-fit: cover; }
    .status-text { font-size: 0.8rem; color: #9ca3af; margin-top: 4px; white-space: pre-wrap;}
</style>
</head>
<body>
<div class="app">
    <h1>Photo Studio Prompt Generator</h1>
    <div class="step-guide">
        <b>Quick Looks:</b> tap a preset card, then generate your prompt.<br>
        <b>Custom Studio:</b> fine-tune clothing, background, lighting, and more before generating.
    </div>
    <div class="tabs">
        <button class="tab-button active" onclick="openTab('quickTab', this)">Quick Looks</button>
        <button class="tab-button" onclick="openTab('customTab', this)">Custom Studio</button>
    </div>
    <div id="quickTab" class="tab-content active">
        <div class="section-title">Pick a studio look</div>
        <div class="quick-grid">
            <div class="preset-card" data-key="classic_headshot" onclick="selectQuickPreset('classic_headshot')"><img src="https://lh3.googleusercontent.com/d/1aVPGd32O9nrj3lQnK1LzC3cojVVintlz" alt=""><div class="preset-card-title">Classic Headshot</div></div>
            <div class="preset-card" data-key="editorial_vogue" onclick="selectQuickPreset('editorial_vogue')"><img src="https://lh3.googleusercontent.com/d/1evE2wqC6TNm3AeBuGsyc0AOIMpP5o8SC" alt=""><div class="preset-card-title">Editorial / Vogue</div></div>
            <div class="preset-card" data-key="beauty_shot" onclick="selectQuickPreset('beauty_shot')"><img src="https://lh3.googleusercontent.com/d/1ErALHoFMF3HsKG8ZEkqc1i_AH0muErSc" alt=""><div class="preset-card-title">Beauty Shot</div></div>
            <div class="preset-card" data-key="dramatic_bw" onclick="selectQuickPreset('dramatic_bw')"><img src="https://lh3.googleusercontent.com/d/1XobSodYaBYlzB6sLLbjK1ljh7iSEjXu-" alt=""><div class="preset-card-title">Dramatic B&W</div></div>
            <div class="preset-card" data-key="fashion_full_body" onclick="selectQuickPreset('fashion_full_body')"><img src="https://lh3.googleusercontent.com/d/118r47NSM_UR3laBpeF0zEVrqraJvqAIU" alt=""><div class="preset-card-title">Full-Body Fashion</div></div>
            <div class="preset-card" data-key="athletic_action" onclick="selectQuickPreset('athletic_action')"><img src="https://lh3.googleusercontent.com/d/1qjRTYC9079CszifEzTqQ5kcYLScwDchX" alt=""><div class="preset-card-title">Athletic / Action</div></div>
            <div class="preset-card" data-key="warm_lifestyle" onclick="selectQuickPreset('warm_lifestyle')"><img src="https://lh3.googleusercontent.com/d/1xSZ1v_SgknyXm0JMpDhQHFqVCB9mOqOq" alt=""><div class="preset-card-title">Warm Lifestyle</div></div>
            <div class="preset-card" data-key="cinematic_gels" onclick="selectQuickPreset('cinematic_gels')"><img src="https://lh3.googleusercontent.com/d/1cf8UW-P46UU0klzHVakp2oSL0gtDIvud" alt=""><div class="preset-card-title">Cinematic Gels</div></div>
            <div class="preset-card" data-key="chair_editorial" onclick="selectQuickPreset('chair_editorial')"><img src="https://lh3.googleusercontent.com/d/1lulyFnIRhWGpjPeK2gWCByN1RNaO6lE7" alt=""><div class="preset-card-title">Chair Editorial</div></div>
            <div class="preset-card" data-key="white_ecom" onclick="selectQuickPreset('white_ecom')"><img src="https://lh3.googleusercontent.com/d/1TZVqTFi0bP2Adfw3v7z3rNwV7Qq4J_j6" alt=""><div class="preset-card-title">White E-com</div></div>
            <div class="preset-card" data-key="moody_spot" onclick="selectQuickPreset('moody_spot')"><img src="https://lh3.googleusercontent.com/d/1ZrWkCwKPQ9o8pJ8gCrgGDIj87yjBNDYz" alt=""><div class="preset-card-title">Moody Spot</div></div>
            <div class="preset-card" data-key="color_blocked" onclick="selectQuickPreset('color_blocked')"><img src="https://lh3.googleusercontent.com/d/1Pl0CbStdsKOe5w7a6z4dcOjxTjw7cpKF" alt=""><div class="preset-card-title">Color-Blocked</div></div>
            <div class="preset-card" data-key="high_key_pastel" onclick="selectQuickPreset('high_key_pastel')"><img src="https://lh3.googleusercontent.com/d/1FRNYrrqbXiE9z6YIZQkOsiULmM--rUJJ" alt=""><div class="preset-card-title">High-Key Pastel</div></div>
            <div class="preset-card" data-key="luxury_noir" onclick="selectQuickPreset('luxury_noir')"><img src="https://lh3.googleusercontent.com/d/1VlGCuyHqHGBFBNBPHk2AHDcLebNBJvHF" alt=""><div class="preset-card-title">Luxury Noir</div></div>
            <div class="preset-card" data-key="prop_environmental" onclick="selectQuickPreset('prop_environmental')"><img src="https://lh3.googleusercontent.com/d/1ytjySKyIyuCMHrbFuGrsjFbaErFIYydR" alt=""><div class="preset-card-title">Prop / Environmental</div></div>
        </div>
        <div class="preset-preview-box">
            <img id="presetPreview" src="" alt="Preset style preview">
            <div class="preset-preview-caption" id="presetPreviewCaption" style="display:none;">Enlarged preview of the selected studio preset.</div>
        </div>
        <div class="hint">Casual mode: pick a look above, then scroll to the prompt section and tap <b>Generate</b>.</div>
    </div>
    <div id="customTab" class="tab-content">
        <div class="section-title">Preset & Identity</div>
        <div class="field">
            <label>Start from a preset (optional)</label>
            <select id="presetSelect">
                <option value="">â€” Select a studio preset â€”</option>
                <option value="classic_headshot">Classic Headshot (Corporate)</option>
                <option value="editorial_vogue">Editorial / Vogue-Style Portrait</option>
                <option value="beauty_shot">Beauty Shot / Close-Up</option>
                <option value="dramatic_bw">Dramatic Black & White Portrait</option>
                <option value="fashion_full_body">Full-Body Fashion Studio Shot</option>
                <option value="athletic_action">Athletic / Action Studio Portrait</option>
                <option value="warm_lifestyle">Warm Lifestyle-Inspired Portrait</option>
                <option value="cinematic_gels">Cinematic Portrait with Colored Gels</option>
                <option value="chair_editorial">Editorial Sitting (Chair Portrait</option>
                <option value="white_ecom">Ultra Clean White E-commerce Style</option>
                <option value="moody_spot">Moody Dark Portrait with Spot Lighting</option>
                <option value="color_blocked">Color-Blocked Retro Studio Portrait</option>
                <option value="high_key_pastel">High-Key Soft Pastel Portrait</option>
                <option value="luxury_noir">Luxury Noir Studio Portrait</option>
                <option value="prop_environmental">Studio Environmental Prop Portrait</option>
            </select>
            <span class="hint">Choosing a preset fills all fields below; you can tweak anything before generating.</span>
        </div>
        <div class="field-group" style="grid-template-columns: 1fr 1fr; margin-top: 6px;"><div class="field"><label><input type="checkbox" id="tagIdentity" checked> Preserve identity</label><label><input type="checkbox" id="tagFeatures" checked> Keep facial features</label><label><input type="checkbox" id="tagAge" checked> Keep age/skin tone</label></div><div class="field"><label><input type="checkbox" id="tagLikeness" checked> Strong likeness</label><label><input type="checkbox" id="tagDSLR" checked> 85mm lens look</label><label><input type="checkbox" id="tagStudio" checked> Studio clarity</label></div></div>
        <div class="section-title">Appearance</div><div class="field-group"><div class="field"><label>Clothing style</label><select id="clothingSelect"><option value="tailored business attire">Tailored business attire</option><option value="high-fashion black turtleneck">High-fashion black turtleneck</option><option value="casual streetwear hoodie and jeans">Casual streetwear hoodie and jeans</option><option value="cozy knit sweater">Cozy knit sweater</option><option value="athletic performance gear">Athletic performance gear</option><option value="elegant evening outfit">Elegant evening outfit</option><option value="custom">âž• Custom clothingâ€¦</option></select><input type="text" id="clothingCustom" class="custom-input" placeholder="Custom"></div><div class="field"><label>Background</label><select id="backgroundSelect"><option value="a neutral grey gradient studio backdrop">Neutral grey</option><option value="a pure white cyclorama background">Pure white cyclorama</option><option value="a textured charcoal studio background">Textured charcoal</option><option value="a soft pastel gradient backdrop">Soft pastel gradient</option><option value="a dark cinematic background fading into black">Dark cinematic</option><option value="a bold color-block studio background">Bold color-block</option><option value="custom">âž• Custom backgroundâ€¦</option></select><input type="text" id="backgroundCustom" class="custom-input" placeholder="Custom"></div></div>
        <div class="section-title">Setup</div><div class="field-group"><div class="field"><label>Lighting</label><select id="lightingSelect"><option value="soft studio key light with gentle fill light">Soft key light</option><option value="classic Rembrandt lighting with controlled shadows">Rembrandt lighting</option><option value="high-key beauty lighting from above and below the face">High-key beauty</option><option value="dramatic low-key lighting from one side with strong shadows">Dramatic low-key</option><option value="cinematic lighting using teal and orange color gels">Teal & orange gels</option><option value="even, shadowless lighting suitable for catalog photography">Even, shadowless</option><option value="custom">âž• Custom lightingâ€¦</option></select><input type="text" id="lightingCustom" class="custom-input" placeholder="Custom"></div><div class="field"><label>Pose</label><select id="poseSelect"><option value="a relaxed three-quarter pose">Relaxed 3/4 pose</option><option value="a confident straight-on stance">Confident straight-on</option><option value="a seated pose, leaning slightly forward">Seated, leaning forward</option><option value="a casual standing pose with hands in pockets">Hands in pockets</option><option value="a dynamic action pose">Dynamic action pose</option><option value="an introspective pose with chin on hand">Chin on hand</option><option value="custom">âž• Custom poseâ€¦</option></select><input type="text" id="poseCustom" class="custom-input" placeholder="Custom"></div></div>
         <div class="section-title">Expression & Extras</div><div class="field-group"><div class="field"><label>Expression</label><select id="expressionSelect"><option value="a soft, confident smile">Soft smile</option><option value="a serious, contemplative expression">Serious/contemplative</option><option value="a subtle, playful smirk">Subtle smirk</option><option value="a bright, joyful smile with engaged eyes">Bright joyful smile</option><option value="a calm, introspective gaze slightly away">Calm gaze away</option><option value="an intense, focused look directly into the camera">Intense stare</option><option value="custom">âž• Custom expressionâ€¦</option></select><input type="text" id="expressionCustom" class="custom-input" placeholder="Custom"></div><div class="field"><label>Extra details</label><input type="text" id="extraInput" placeholder="e.g., 4K resolution"></div></div>
    </div>

    <div class="image-upload-section">
        <div class="section-title">Reference Photo (required)</div>
        <div class="field">
            <label for="imageInput">Upload a portrait photo (Max 2MB)</label>
            <input type="file" id="imageInput" accept="image/*">
            <img id="userImagePreview" class="image-preview" alt="Uploaded reference preview">
            <div class="hint">Used only for this generation session.</div>
        </div>
    </div>
    <div class="prompt-panel">
        <div class="prompt-title">Generated Prompt & Output</div>
        <div class="buttons">
            <button class="btn-primary" id="generateBtn">âš¡ Generate Image</button>
            <button class="btn-secondary" id="copyBtn">ðŸ“‹ Copy Prompt</button>
            <button class="btn-secondary" id="clearBtn">ðŸ§¹ Clear</button>
        </div>
        <textarea id="promptOutput" placeholder="Prompt will appear hereâ€¦"></textarea>
        <div class="status-text" id="statusText"></div>
        <div class="section-title" style="margin-top: 14px;">AI Output Image</div>
        <div class="preset-preview-box">
            <img id="generatedImage" class="image-preview" alt="AI-generated studio portrait">
            <div class="preset-preview-caption" id="generatedImageCaption" style="display:none;">AI-generated studio portrait.</div>
        </div>
    </div>
</div>

<script>
    // *** THIS IS THE UPDATED URL YOU PROVIDED ***
    const GEMINI_PROXY_ENDPOINT = "https://script.google.com/macros/s/AKfycbwkqhlz1YOCzSo1SnEThuh98VKaiupguitp2ur4t-Z_WTG-HBc49OXx3ojOsczG5aLT/exec";
    
    const GEMINI_MODEL = "gemini-2.5-flash-image";

    // --- PRESET DEFINITIONS ---
    const PRESETS = {
        classic_headshot: { clothing: "tailored business attire", background: "a neutral grey gradient studio backdrop", lighting: "soft studio key light with gentle fill light", pose: "a relaxed three-quarter pose", expression: "a soft, confident smile", extra: "Professional headshot, shallow depth of field." },
        editorial_vogue: { clothing: "a high-fashion black turtleneck", background: "a textured charcoal studio background", lighting: "classic Rembrandt lighting", pose: "confident straight-on stance", expression: "serious, contemplative", extra: "High-end fashion magazine editorial feeling." },
        beauty_shot: { clothing: "a simple, cozy knit sweater", background: "a soft pastel gradient backdrop", lighting: "high-key beauty lighting", pose: "relaxed three-quarter pose", expression: "soft, confident smile", extra: "Close-up beauty portrait emphasizing eyes and skin texture." },
        dramatic_bw: { clothing: "a high-fashion black turtleneck", background: "a dark cinematic background fading into black", lighting: "dramatic low-key lighting from one side", pose: "introspective pose with chin on hand", expression: "serious, contemplative", extra: "Black and white, deep contrast, dramatic shadows." },
        fashion_full_body: { clothing: "an elegant evening outfit", background: "a pure white cyclorama background", lighting: "even, shadowless lighting", pose: "casual standing pose with hands in pockets", expression: "subtle, playful smirk", extra: "Full body shot for a fashion catalog." },
        athletic_action: { clothing: "athletic performance gear", background: "a dark cinematic background", lighting: "dramatic low-key lighting", pose: "dynamic action pose suggesting motion", expression: "intense, focused look", extra: "Emphasize strength and motion, sculpting light." },
        warm_lifestyle: { clothing: "a cozy knit sweater", background: "a soft pastel gradient backdrop", lighting: "soft studio key light", pose: "relaxed three-quarter pose", expression: "bright, joyful smile", extra: "Warm, approachable lifestyle branding shot." },
        cinematic_gels: { clothing: "casual streetwear hoodie and jeans", background: "a dark cinematic background", lighting: "cinematic lighting using teal and orange color gels", pose: "confident straight-on stance", expression: "intense, focused look", extra: "Neon-lit atmosphere, strong color contrast." },
        chair_editorial: { clothing: "tailored business attire", background: "a textured charcoal studio background", lighting: "soft studio key light", pose: "seated pose, leaning slightly forward", expression: "soft, confident smile", extra: "Include a simple studio chair as a prop." },
        white_ecom: { clothing: "casual streetwear", background: "a pure white cyclorama background", lighting: "even, shadowless lighting", pose: "confident straight-on stance", expression: "soft, confident smile", extra: "Clean e-commerce look, no distractions." },
        moody_spot: { clothing: "a simple dark top", background: "a dark cinematic background fading into black", lighting: "dramatic low-key lighting with spot", pose: "relaxed three-quarter pose", expression: "serious, contemplative", extra: "Concentrated pool of light on the face." },
        color_blocked: { clothing: "casual streetwear with complementary color", background: "a bold color-block studio background", lighting: "even, shadowless lighting", pose: "casual standing pose", expression: "subtle, playful smirk", extra: "Fun, retro, graphic design feeling." },
        high_key_pastel: { clothing: "a light-colored outfit", background: "a soft pastel gradient backdrop", lighting: "high-key beauty lighting", pose: "relaxed three-quarter pose", expression: "bright, joyful smile", extra: "Bright, airy, cheerful exposure." },
        luxury_noir: { clothing: "an elegant evening outfit", background: "a dark cinematic background", lighting: "dramatic low-key lighting", pose: "confident straight-on stance", expression: "serious, contemplative", extra: "Luxurious film noir look, high-end campaign." },
        prop_environmental: { clothing: "smart casual clothing", background: "a neutral grey gradient backdrop", lighting: "soft studio key light", pose: "seated pose, leaning forward", expression: "calm, introspective gaze", extra: "Include a simple studio prop like a stool or plant." }
    };

    // --- HELPER FUNCTIONS ---
    function setField(selectId, customId, value) {
        const selectEl = document.getElementById(selectId);
        const customEl = document.getElementById(customId);
        if (!selectEl || !customEl || !value) return;
        let matched = false;
        for (let i = 0; i < selectEl.options.length; i++) { if (selectEl.options[i].value === value) { selectEl.value = value; matched = true; break; } }
        if (matched) { customEl.value = ""; } else { selectEl.value = "custom"; customEl.value = value; }
    }

    function updatePresetPreview(key) {
        const img = document.getElementById("presetPreview");
        const caption = document.getElementById("presetPreviewCaption");
        img.style.display = "none"; caption.style.display = "none";
    }

    function applyPreset(key) {
        const preset = PRESETS[key];
        if (!preset) return;
        const ids = ["tagIdentity","tagFeatures","tagAge","tagLikeness","tagDSLR","tagStudio"];
        ids.forEach(id => { const el = document.getElementById(id); if (el) el.checked = true; });
        setField("clothingSelect", "clothingCustom", preset.clothing);
        setField("backgroundSelect", "backgroundCustom", preset.background);
        setField("lightingSelect", "lightingCustom", preset.lighting);
        setField("poseSelect", "poseCustom", preset.pose);
        setField("expressionSelect", "expressionCustom", preset.expression);
        document.getElementById("extraInput").value = preset.extra || "";
        document.getElementById("promptOutput").value = "";
    }

    function selectQuickPreset(key) {
        applyPreset(key);
        updatePresetPreview(key);
        const cards = document.querySelectorAll(".preset-card");
        cards.forEach(card => card.classList.remove("selected"));
        const active = document.querySelector(`.preset-card[data-key="${key}"]`);
        if (active) active.classList.add("selected");
    }

    function getFieldValue(selectId, customId) {
        const selectEl = document.getElementById(selectId);
        const customEl = document.getElementById(customId);
        if (!selectEl || !customEl) return "";
        if (selectEl.value === "custom" && customEl.value.trim() !== "") return customEl.value.trim();
        return selectEl.value !== "custom" ? selectEl.value : "";
    }

    function buildPrompt() {
        const clothing = getFieldValue("clothingSelect", "clothingCustom");
        const background = getFieldValue("backgroundSelect", "backgroundCustom");
        const lighting = getFieldValue("lightingSelect", "lightingCustom");
        const pose = getFieldValue("poseSelect", "poseCustom");
        const expression = getFieldValue("expressionSelect", "expressionCustom");
        const extra = document.getElementById("extraInput").value.trim();

        const identityParts = [];
        if (document.getElementById("tagIdentity").checked) identityParts.push("Preserve face identity from reference.");
        if (document.getElementById("tagFeatures").checked) identityParts.push("Keep facial features.");
        if (document.getElementById("tagAge").checked) identityParts.push("Keep age and skin tone.");
        if (document.getElementById("tagLikeness").checked) identityParts.push("Strong likeness.");

        const technicalParts = [];
        if (document.getElementById("tagDSLR").checked) technicalParts.push("85mm DSLR look, shallow depth of field.");
        if (document.getElementById("tagStudio").checked) technicalParts.push("Professional studio clarity.");

        const descriptionParts = [];
        if (clothing) descriptionParts.push("Wearing " + clothing);
        if (background) descriptionParts.push("Background is " + background);
        if (lighting) descriptionParts.push("Lighting: " + lighting);
        if (pose) descriptionParts.push("Pose: " + pose);
        if (expression) descriptionParts.push("Expression: " + expression);

        let fullPrompt = "Reference image provided. Create a high-resolution studio portrait. " + identityParts.join(" ") + " " + technicalParts.join(" ") + "\n";
        if (descriptionParts.length > 0) fullPrompt += "Details: " + descriptionParts.join(", ") + ".\n";
        if (extra) fullPrompt += "Notes: " + extra;
        
        return fullPrompt.trim();
    }

    function openTab(tabName, clickedButton) {
        const tabcontent = document.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) tabcontent[i].classList.remove("active");
        const tablinks = document.getElementsByClassName("tab-button");
        for (let i = 0; i < tablinks.length; i++) tablinks[i].classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        if (clickedButton) clickedButton.classList.add("active");
    }

    // --- FILE HANDLING & API CALL ---

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            // Stricter 2MB limit
            if (file.size > 2 * 1024 * 1024) {
                 reject(new Error("Image is too large. Please pick one under 2MB.")); return;
            }
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const result = reader.result || "";
                    const str = String(result);
                    const idx = str.indexOf(",");
                    const base64 = idx >= 0 ? str.slice(idx + 1) : str;
                    resolve({ base64, mimeType: file.type || "image/jpeg" });
                } catch (e) { reject(new Error("Could not process image file.")); }
            };
            reader.onerror = () => reject(new Error("Error reading file."));
            reader.readAsDataURL(file);
        });
    }

    async function callGeminiProxy(promptText, imageFile) {
        const statusEl = document.getElementById("statusText");
        const outputImg = document.getElementById("generatedImage");
        const outputCaption = document.getElementById("generatedImageCaption");

        statusEl.textContent = "Processing image...";
        outputImg.style.display = "none";
        outputCaption.style.display = "none";

        const { base64, mimeType } = await fileToBase64(imageFile);

        statusEl.textContent = "Sending to server (this may take 20-40 seconds)...";

        // Prepare data
        const payload = {
            prompt: promptText,
            imageBase64: base64,
            mimeType: mimeType,
            model: GEMINI_MODEL
        };

        // THE NUCLEAR OPTION FOR CORS:
        // Using text/plain content type forces the browser to skip preflight checks
        // and send the data directly to Apps Script, which then parses it as a string.
        const res = await fetch(GEMINI_PROXY_ENDPOINT, {
            method: "POST",
            mode: 'cors', 
            headers: { "Content-Type": "text/plain;charset=utf-8" }, 
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            throw new Error(`Server connection failed (${res.status})`);
        }

        statusEl.textContent = "Processing response...";
        const data = await res.json();

        if (data.proxyError) throw new Error("Proxy Error: " + data.proxyError);

        const candidates = data.candidates || [];
        if (!candidates.length) {
            if (data.promptFeedback?.blockReason) throw new Error("Blocked: " + data.promptFeedback.blockReason);
            throw new Error("No image generated by AI.");
        }

        const imgPart = candidates[0].content?.parts?.find(p => p.inlineData || p.inline_data);
        if (!imgPart) throw new Error("AI response missing image data.");

        const inline = imgPart.inlineData || imgPart.inline_data;
        outputImg.src = `data:${inline.mimeType || "image/png"};base64,${inline.data}`;
        outputImg.style.display = "block";
        outputCaption.style.display = "block";
        statusEl.textContent = "Image created successfully âœ…";
    }

    async function handleGenerateClick() {
        const statusEl = document.getElementById("statusText");
        const btn = document.getElementById("generateBtn");
        statusEl.textContent = ""; statusEl.style.color = "#9ca3af";
        
        const promptText = buildPrompt();
        document.getElementById("promptOutput").value = promptText;
        if (!promptText) { alert("Please select settings first."); return; }

        const fileInput = document.getElementById("imageInput");
        const imageFile = fileInput.files && fileInput.files[0];
        if (!imageFile) { alert("Please upload a photo."); return; }

        try {
            btn.disabled = true; btn.textContent = "Generating...";
            await callGeminiProxy(promptText, imageFile);
        } catch (err) {
            console.error(err);
            statusEl.style.color = "#ef4444";
            statusEl.textContent = "Error: " + (err.message || String(err));
        } finally {
            btn.disabled = false; btn.textContent = "âš¡ Generate Image";
        }
    }

    // --- EVENT LISTENERS ---
    document.getElementById("presetSelect").addEventListener("change", (e) => {
        if (e.target.value) selectQuickPreset(e.target.value);
    });

    document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        const preview = document.getElementById("userImagePreview");
        if (file) {
             // Client-side size check (MUST MATCH FILETOBASE64 LIMIT)
            if (file.size > 2 * 1024 * 1024) {
                alert("Image is too large. Please pick one under 2MB.");
                e.target.value = ""; 
                preview.style.display = "none";
                return;
            }
            const reader = new FileReader();
            reader.onload = () => { preview.src = reader.result; preview.style.display = "block"; };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = "none"; preview.src = "";
        }
    });

    document.getElementById("generateBtn").addEventListener("click", handleGenerateClick);
    document.getElementById("copyBtn").addEventListener("click", () => {
        const text = document.getElementById("promptOutput").value.trim();
        if (!text) return;
        navigator.clipboard.writeText(text);
        const btn = document.getElementById("copyBtn");
        btn.textContent = "âœ… Copied!"; setTimeout(() => (btn.textContent = "ðŸ“‹ Copy Prompt"), 1200);
    });
    document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("promptOutput").value = "";
        document.getElementById("statusText").textContent = "";
        document.getElementById("generatedImage").style.display = "none";
        document.getElementById("generatedImageCaption").style.display = "none";
    });

    window.onload = function() { openTab('quickTab', document.querySelector('.tab-button')); };
</script>
</body>
</html>
